# Техническое видение проекта

## Технологии

**Backend Framework:**
- **Litestar** — современный Python веб-фреймворк с поддержкой async/await и встроенным CLI
- **Pydantic** — валидация данных и сериализация
- **Pydantic Settings** — управление конфигурацией

**База данных:**
- **PostgreSQL** — основная реляционная БД
- **SQLAlchemy** — ORM с async поддержкой
- **Alembic** — миграции БД
- **psycopg** — PostgreSQL драйвер

**Аутентификация и безопасность:**
- **Passlib** — хэширование паролей
- **Argon2** — алгоритм хэширования
- **PySETO** — токены аутентификации

**Хранилище файлов:**
- **MinIO** — S3-совместимое объектное хранилище
- **miniopy-async** — асинхронный клиент MinIO

**Frontend:**
- **HTMX** — серверный рендеринг с динамикой без SPA
- **Hyperscript** — лёгкий клиентский JS для управления поведением элементов
- **Bootstrap** — готовые UI-компоненты, тёмная тема

**Логирование и мониторинг:**
- **Structlog** — структурированное логирование
- **ECS Logging** — формат логов Elastic Common Schema
- **Sentry** — мониторинг ошибок
- *(опционально в будущем)* — Prometheus/Grafana для метрик

**CLI:**
- **Litestar CLI** — встроенные команды фреймворка

---

## Принципы разработки

**Архитектурные принципы:**
- **Clean Architecture** — разделение на слои (core, db, entrypoints, ioc)
- **Dependency Injection** — IOC контейнер (Dishka) для управления зависимостями
- **Separation of Concerns** — чёткое разделение ответственности

**Принципы кода:**
- **Type Hints** — обязательное использование типизации (mypy)
- **Async/Await** — асинхронное программирование везде, где возможно
- **Pydantic Models** — строгая валидация данных
- **Error Handling** — централизованная обработка ошибок

**Принципы тестирования:**
- **Фокус на простых и понятных тестах**  
- **100% покрытие Core слоя** (use_cases, правила домена)  
- **Приоритет критической бизнес-логики**  
- **Fixtures** — переиспользуемые тестовые данные

**Принципы безопасности:**
- **Input Validation** — валидация всех входящих данных
- **Authentication** — PASETO токены
- **Authorization** — проверка прав доступа на уровне use cases

---

## Структура проекта

**Корневая структура:**
```
my-site/
├── docker/            # Docker конфигурация
├── docs/              # Документация проекта
├── src/               # Исходный код приложения
├── tests/             # Автотесты
├── pyproject.toml     # Конфигурация проекта и зависимости
├── docker-compose.yml # Docker Compose конфигурация
└── Makefile           # Команды для разработки
```

**Структура src/:**
```
src/
├── config/            # Конфигурация приложения
├── core/              # Бизнес-логика (Clean Architecture)
├── db/                # Модели БД и миграции
├── entrypoints/       # Точки входа (API, Views, CLI)
├── ioc/               # Inversion of Control контейнер
├── static/            # Статические файлы
├── templates/         # HTML шаблоны
└── main.py            # Точка входа приложения
```

**Основные каталоги:**
- **config/** — настройки, логгирование, инициализация компонентов  
- **db/** — модели, репозитории, миграции  
- **entrypoints/** — API, HTMX views, CLI, admin  
- **ioc/** — DI контейнер и провайдеры  
- **core/** — бизнес-логика (blog, competency_matrix, contacts, users)  
- **templates/** — HTML-шаблоны, базовые блоки  
- **static/** — стили, изображения, ресурсы редактора  

---

## Архитектура проекта

**Слои архитектуры:**
1. **Core Layer** — бизнес-логика (use_cases, schemas, exceptions)  
2. **DB Layer** — работа с данными (models, storages, migrations)  
3. **Entrypoints Layer** — точки входа (API, views, CLI)  
4. **IOC Layer** — управление зависимостями  
5. **Clients Layer** *(потенциальное расширение)* — интеграции с внешними сервисами  
6. **Services Layer** *(потенциальное расширение)* — общие сервисы для use_cases  

**Принципы взаимодействия:**  
- Слои взаимодействуют только с соседними  
- Через абстракции, а не реализации  
- Все зависимости инжектируются через IOC  

---

## Сценарии работы

**Пользовательские сценарии:**
1. Просмотр матрицы компетенций (поиск, фильтрация, подсказки)  
2. Чтение блога (Markdown статьи, навигация)  
3. Отправка формы контактов  
4. Администрирование:  
   - управление записями блога  
   - управление вопросами матрицы компетенций  

**API endpoints:**
- **HTMX views** — основной фронтенд  
- **REST API** — публичное API для интеграций  
- **CLI команды** — вспомогательные утилиты  

---

## Деплой

**Принципы контейнеризации:**
- **Multi-stage builds** — оптимизация образов  
- **Отдельные контейнеры** — backend, database, storage, nginx  
- **Health checks** для сервисов  
- **Volume mounts** для хранения данных  

**CI/CD:**
- **CI при каждом push** — линтеры, тесты  
- **Деплой по требованию** — workflow_dispatch  

**Окружения:**
- **Local** — разработка через Docker Compose или `uvicorn --reload`  
- **Production** — сервер с Docker + Nginx  
- **Без staging** — два окружения достаточно  

**Процесс деплоя:**
1. Push в репозиторий → запуск CI/CD  
2. Сборка Docker-образов (с тегами `latest` и `commit SHA`)  
3. Push в Docker Registry  
4. Синхронизация инфраструктуры (`docker-compose.yml`, `docker/`, `.env`) на сервер  
5. Перезапуск сервисов (`make run`)  

**Environment variables:**
- Все настройки через env vars  
- Разделение Local/Production  
- Секреты через Github Secrets  
- Обязательная валидация при старте  

---

## Логирование и мониторинг

**Структурированное логирование:**
- **Structlog** как основной инструмент  
- **ECS Logging** для production  
- **Request ID** для трейсинга  

**Режимы:**
- **Debug** — цветной вывод для разработки  
- **Production** — ECS формат  

**Мониторинг:**
- **Sentry** для ошибок  
- Контекстные переменные в логах  
- *(потенциально)* Prometheus/Grafana для метрик  
