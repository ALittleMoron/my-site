# TODOs

## Этапы разработки

### ЭТАП 1 — Минимально жизнеспособный продукт (MVP)

- [x] Список матрицы компетенций в виде сетки и списка
- [x] Раздел "обо мне"
- [x] Возможность связаться со мной
- [x] Блог (без АПИ, только core-функционал)
- [x] Админка на SQLAdmin

- [x] Добавить Databasus для бэкапа базы данных
- [x] Настроить letsencrypt
- [x] Убрать password_hash из доменной модели User
- [x] Убрать информацию о менторстве. Раздел "обо мне" оставить.
- [x] Починить статику на minio и сервисе backup'ов.
- [x] (SEO) Добавить ссылку canonical
- [x] Провалидировать css (сделать упор на override переменных bootstrap)
- [x] Перенести bootstrap (и все остальные файлы, по необходимости) в папку со статикой
- [x] Переделать админку на litestar
  - [x] Вычистить SQLAdmin
    - [x] Удалить запуск админки (docker, create_admin + Makefile)
    - [x] Перенести /presign-put в litestar ручку.
    - [x] Перенести apply_template_callables в litestar
    - [x] Убрать ненужные настройки из litestar (админка, auth)
    - [x] Убрать использование админки в коде
    - [x] Убрать зависимости от sqladmin из uv
  - [x] Редактирование матрицы компетенций прямо на сайте (не полная)
    - [x] (BACK) Фильтр опубликованности вопросов матрицы компетенций (только для админа)
    - [x] (FRONT) Тумблер переключения режима вывода списка вопросов: только опубликованные и все
    - [x] (BACK) Расширенный ответ по деталке вопроса матрицы компетенций (дополнительно статус вопроса)
    - [x] (BACK) CRUD для вопросов матрицы компетенций (включая вложенные сущности) + guard
      - [x] Create
      - [x] Update
      - [x] Delete
      - [x] Опубликовать
      - [x] Снять с публикации
    - [x] (BACK) guard на /api/files/presign-put
    - [x] (FRONT) Кнопка удаления вопроса на деталке вопроса
    - [x] (FRONT) Кнопка Опубликовать/снять с публикации (в зависимости от статуса)
  - [x] базовая авторизация и проверка прав на редактирование (PASETO без сессии. Сессия потом)
    - [x] (FRONT) Страница логина с кнопкой логина на главной (пока скрыть)
    - [x] (BACK) логика логина
    - [x] (FRONT) кнопка логаута на главной (пока скрыть)
    - [x] (BACK) логика логаута (ничего не делает)
    - [x] (BACK) guard на проверку авторизации (пока только админы могут войти)
    - [x] (BACK) Сделать анонимного пользователя
- [x] Провести смоук-тест
  - [x] Поиск по матрице компетенций должен работать, как и прежде: поиск, layout.
  - [x] Модалка вопроса матрицы компетенций должна открываться, блоки с кодом должны форматироваться
  - [x] Запустить docker-compose и проверить работу смежных сервисов
- [ ] Деплой на удалённый сервер
  - [ ] Выбрать хостинг
  - [ ] Прокинуть недостающие секреты
  - [ ] Провести деплой строго из github workflow
  - [ ] После деплоя зайти на торчащие наружу сервисы и проверить авторизацию

### ЭТАП 1.5 — Улучшения MVP, доработка текущего функционала

- [ ] (SEO) Добавить ссылку schemaMarkup
- [ ] Проверить оптимизацию сайта
  - [ ] Сделать нагрузочное тестирование (locust)
  - [ ] Проверить сайт через Lighthouse. Поправить ошибки и улучшить показатели
- [ ] Сделать закрытое тестирование MVP с реальными пользователями (друзья, коллеги). Собрать фидбек и
  исправить критичные баги.
- [ ] Добавить базовую аналитику (Matomo) для отслеживания поведения пользователей на сайте.
- [ ] Оптимизировать время загрузки страниц (минификация CSS и JS, оптимизация изображений).
      Возможно, нужно вынести статику на CDN.
- [ ] Перенести матрицу компетенций из Google Docs в базу данных.
- [ ] Аудит безопасности MVP. Проверить на уязвимости и исправить найденные проблемы.
  - [x] Найти checklist по безопасности веб-приложений и пройтись по нему.
  - [ ] Сформировать модель угроз (кто атакующий, что хотят и т.д.). Записать в docs файл.
  - [ ] HTTP заголовки безопасности. в ответах есть нужные header'ы
    - [ ] Strict-Transport-Security
    - [ ] X-Content-Type-Options: nosniff
    - [ ] X-Frame-Options: DENY
    - [ ] Referrer-Policy: no-referrer
    - [ ] Content-Security-Policy
  - [ ] CSRF
    - [ ] Все POST/PUT/PATCH/DELETE защищены от CSRF
    - [ ] CSRF-токен в cookie + header
    - [ ] CSRF проверяется на сервере
  - [ ] HTTPS и TLS
    - [ ] Всё редиректится на HTTPS
    - [ ] HTTP вообще не обслуживается
    - [ ] TLS ≥ 1.2
    - [ ] Certbot обновляется автоматически
    - [ ] Нет внутренних сервисов, торчащих наружу
  - [ ] XSS
    - [ ] Все пользовательские данные экранируются
    - [ ] Нет `| safe` без 100% уверенности
    - [ ] Нельзя сохранить <script> в БД и потом отрендерить. Проверить БД на наличие таких блоков.
    - [ ] Используется CSP
  - [ ] Пароли никогда не логируются
  - [ ] Хеширование: используется уникальная соль
  - [ ] Каждый защищённый handler проверяет пользователя (guard'ы там, где нужны)
  - [ ] Нет логики «если не админ — не показываем кнопку» (Подумать, как это исправить)
  - [ ] Есть все проверки на бэке. Можно дублировать на фронт, но нет ситуации, когда проверка
    ТОЛЬКО на фронте
  - [ ] Docker и инфраструктура
    - [ ] Приложение работает с `read_only: true`
    - [ ] Writable только для `/tmp` и явно нужных `volumes:`
    - [ ] Нет записи в `/etc`, `/usr`, `/bin`
    - [ ] Нет bind mount'ов вида: `- ./:/app`
    - [ ] Контейнеры не работают под root
    - [ ] UID/GID не 0
    - [ ] Нет sudo внутри контейнера
    - [ ] Используются user-defined networks
    - [ ] В public торчит только nginx
    - [ ] Нет хардкода IP
    - [ ] Сервисы доступны только по имени сети
    - [ ] Нет обращения по localhost
    - [ ] Нет чувствительных данных в `docker inspect`
    - [ ] Логи не пишутся в файлы внутри контейнера
    - [ ] Есть log rotation
    - [ ] У всех сервисов есть healthcheck
    - [ ] Nginx не шлёт трафик в unhealthy backend
    - [ ] Restart policy адекватная
    - [ ] Версии образов чётко зафиксированы
    - [ ] Нет latest
    - [ ] Образы обновляются
    - [ ] Минимальное количество пакетов
    - [ ] Nginx не root
    - [ ] У nginx нет прав на запись
    - [ ] Нет `proxy_pass` на localhost
    - [ ] Нет `network_mode: host`
    - [ ] Нет `privileged: true`
    - [ ] Нет проброса `/var/run/docker.sock`
    - [ ] Нет cap_add без крайней необходимости
    - [ ] Нет `devices:` без реальной необходимости
    - [ ] `cap_drop: [ALL]` где возможно
    - [ ] Секреты не в образах
    - [ ] Инфраструктурные сервисы не проброшены наружу
      - [ ] PostgreSQL
      - [ ] Valkey
    - [ ] Postgres, Valkey, MinIO не имеют ports
    - [ ] MinIO закрыт под auth
    - [ ] Databasus закрыт под auth
    - [ ] `.env` не в git
    - [ ] Нет секретов в логах
    - [ ] Все ключи длинные и случайные
    - [ ] не показывают stacktrace пользователю
    - [ ] На хосте включён firewall (ufw/iptables)
    - [ ] Открыты только 80 и 443
    - [ ] ssh только по ключу. Вход по паролю выключен
  - [ ] Rate limiting и защита от ботов
    - [ ] Rate limit на логин, регистрацию и сброс пароля
    - [ ] Ограничение по IP / fingerprint
    - [ ] Нет бесконечных запросов к тяжёлым эндпоинтам
  - [ ] Backup & восстановление
    - [ ] Бэкапы зашифрованы
    - [ ] Бэкапы недоступны публично
    - [ ] Ты проверял восстановление
    - [ ] Нет доступа к backup-панели без auth
  - [] Supply chain
    - [ ] Фиксированные версии зависимостей
    - [ ] Регулярно обновляешь зависимости
    - [ ] Нет pip install из сомнительных источников 

### ЭТАП 2 — Frontend

- [ ] Соглашение на использование cookies.
- [ ] Перейти на полноценный frontend-framework (angular, скорее всего)
- [ ] Поправить поиск вопросов на фронте: нужно, чтобы удалялись также пустые разделы
- [ ] Сделать текст выделения на сайте в цвет темы.
- [ ] Добавить больше обратной связи при запросах в API (нотификации, ошибки и т.д.)
- [ ] Добавление и редактирование вопросов матрицы компетенций
    - [ ] Поиск по существующим внешним ресурсам
    - [ ] Режим редактирования конкретного вопроса (кнопка и форма на деталке вопроса)
    - [ ] Кнопка и форма добавления вопроса в нужном разделе матрицы компетенций
    - [ ] ToastUI должен работать, как и прежде: загрузка файлов через /presign-put, отображение
      загруженных файлов, редактирование контента, сохранение контента.
- [ ] Аудит безопасности
  - [ ] редактировать, добавлять и удалять вопросы матрицы может только администратор

### ЭТАП 3 — Блог и Flashcards

- [ ] Создание карточек из матрицы компетенций (stateless — без сохранения, перезапуск = новый набор
  карточек)
- [ ] Создание самописных карточек
- [ ] экспорт карточек пользователя в .apkg формат

- [ ] Вывод постов по дате публикации
- [ ] Фильтры постов по тэгам и дате
- [ ] Поиск постов по названию и контенту
- [ ] Реакции на посты

### ЭТАП 4 — Авторизация и Пользователи

- [ ] Доработка аутентификация пользователей (возможно, через OAuth2)
  - [ ] (FRONT) Кнопка и форма регистрации
  - [ ] (BACK) Логика регистрации
  - [ ] (FRONT) Кнопка и форма восстановления пароля (Просто подтверждение с отправкой на почту)
  - [ ] (BACK) Логика восстановления пароля
  - [ ] (BACK) добавление cookie сессии (при логине/регистрации и удаление при логауте)
- [ ] Политика конфидекиальности
- [ ] пользовательское соглашение
- [ ] Согласие на обработку персональных данных
- [ ] Восстановление пароля
- [ ] Подтверждение пароля
- [ ] Создание Flashcards из матрицы компетенций (stateful - сохранение на пользователя)
- [ ] Возможность оставить комментарии к постам в блоге
- [ ] 2FA/MFA для пользователей
- [ ] Профиль пользователя
  - [ ] статистика прохождения курсов
  - [ ] изменение личных данных
  - [ ] настройки уведомлений
  - [ ] просмотр сохранённых карточек flashcards
  - [ ] Список устройств, с которых был выполнен вход в аккаунт
- [ ] Аудит безопасности
  - [ ] Пользователь не может взаимодействовать с чужими профилями. Только смотреть.
  - [ ] Нет токенов в localStorage
  - [ ] Авторизация основана на безопасных cookies: HttpOnly, Secure, SameSite=Lax
  - [ ] Есть ротация сессий при логине
  - [ ] Есть инвалидация сессии при логауте
  - [ ] Истекшие сессии реально удаляются / не принимаются

### ЭТАП 5 - Доработка матрицы и Курсы

- [ ] Добавить отдельный список-очередь для вопросов, которые я хочу добавить в матрицу компетенций
- [ ] Создание шага материала курса (может включать видео, текст, картинки, файлы, тесты)
- [ ] playground для тестов курса
- [ ] Создание курсов, включающих в себя шаги материала курса
- [ ] Привязка курсов к матрице компетенций
- [ ] Просмотр доступных курсов
- [ ] Возможность предложить свой вопрос для матрицы компетенций
- [ ] Возможность отправить информацию об опечатке в матрице компетенций
- [ ] Аудит безопасности
  - [ ] Пользователь не может редактировать прогресс прохождения курса другого пользователя

### ЭТАП 6 — Трасировки и мониторинг

- [ ] Алерты об ошибках в телеграм-бота
- [ ] Подключить Grafana + Prometheus + Loki
- [ ] Подключить сервис мониторинга состояния контейнеров
  - [ ] Слать уведомления при падении контейнеров
  - [ ] Слать уведомления при высоком использовании ресурсов (CPU, RAM)
- [ ] Аудит безопасности
  - [ ] WIP

### ЭТАП 7 — Инфраструктура и Локализация

- [ ] Добавить локализацию в базе данных (возможно, нужна отдельная база под локализации)
- [ ] Добавить выбор локализации на фронте
- [ ] VPN для доступа к внутренним системам
- [ ] Подключить dependabot'а к репозиторию
- [ ] Нужно защитить сайт от ботов
- [ ] Вынести миграцию из app_lifespan в отдельную таску (можно в docker-compose)
- [ ] Заменить uvicorn на granian
- [ ] Аудит безопасности
  - [ ] У обычных пользователей нет доступа к внутренним системам без VPN.

### ЭТАП 8 — Безопасность

- [ ] Dependency scanning (Safety, Bandit)
- [ ] OWASP Top 10 compliance check
- [ ] Возможно, есть AI-агент для поиска уязвимостей в приложении. Поискать и попробовать
- [ ] Повторный аудит безопасности. Взять все вышеуказанные аудиты безопасности и повторить их.

## Ошибки

- [ ] Поиск не работает в режиме "таблица"
- [ ] Поиск по ресурсам работает неоптимально. Нужно подключить полнотекстовый поиск с помощью
  [sqlalchemy-searchable](https://sqlalchemy-searchable.readthedocs.io/en/latest/quickstart.html)

## Документация

- [ ] ADR по написанию кода (code quality)
- [ ] Вынести параметры в АПИ и добавить к ним примеры и другие поля.
- [ ] Удалить ненужные графики в ARD'ах
- [ ] Упростить формулировки, сжать ADR'ы

## Рефакторинг

- [ ] Упростить BootstrapRenderer
- [x] Добавить pre-commit hooks (ruff, mypy, pytest)
- [x] Вынести cli в отдельную точку запуска (из main.py)
- [x] Использовать GradeEnum в API и core-слое.
- [x] Переписать NewType на обычные классы.
