  <div class="admin-editor {{ params.class_ }}">
    <div id="{{ params.textarea_id }}__tui"></div>
    <textarea {{ params.attrs }} id="{{ params.textarea_id }}" name="{{ params.textarea_name }}" class="d-none">{{ params.initial_value|e }}</textarea>
  </div>
  <script>
      (function() {
          const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
          document.getElementById('tui-dark').disabled = !isDark;

          const editor = new toastui.Editor({
              el: document.getElementById('{{ params.textarea_id }}__tui'),
              height: '{{ params.height }}',
              initialEditType: '{{ params.edit_type }}',
              hideModeSwitch: true,
              language: 'ru-RU',
              previewStyle: 'vertical',
              usageStatistics: false,
              initialValue: document.getElementById('{{ params.textarea_id }}').value || '',
              toolbarItems: [
                  ['heading', 'bold', 'italic', 'strike'],
                  ['hr', 'quote', 'ul', 'ol', 'task'],
                  ['table', 'link', 'image', 'code', 'codeblock']
              ],
              placeholder: 'Пожалуйста, вставьте текст.',
              events: {
                  change: function () {
                      document.getElementById('{{ params.textarea_id }}').value = editor.getMarkdown();
                  }
              },
              hooks: {
                  addImageBlobHook: async (blob, callback) => {
                      try {
                          const ct = blob.type || 'application/octet-stream';
                          const res = await fetch('/admin/presign-put?content_type=' + encodeURIComponent(ct), {
                              credentials: 'same-origin'
                          });
                          if (!res.ok) throw new Error('Presign failed');
                          const presign = await res.json();
                          const put = await fetch(presign.uploadUrl, {
                              method: 'PUT',
                              headers: { 'Content-Type': ct },
                              body: blob
                          });
                          if (!put.ok) throw new Error('PUT failed');
                          callback(presign.accessUrl, 'image');
                      } catch (e) {
                          alert('Image upload error: ' + e.message);
                      }
                  }
              }
          });
          window.applyTheme = (theme) => {
              document.documentElement.setAttribute('data-bs-theme', theme);
              document.getElementById('tui-dark').disabled = theme !== 'dark';
          };
      })();
  </script>
